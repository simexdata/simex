
import * as XLSX from 'xlsx'; import jsPDF from 'jspdf'
function flattenEmployee(e){const ratings=e.ratings||{};return {id:e.id,name:e.name,email:e.email,role:e.role,department:e.department,location:e.location||'',hourlyRate:e.hourlyRate??'',rating_aggregate:Math.round(Object.values(ratings).reduce((a,b)=>a+Number(b||0),0)/Math.max(1,Object.keys(ratings).length)),certificates:(e.certificates||[]).map(c=>c.name).join(', ')}}
export function exportEmployeesToXLSX(list){const rows=list.map(flattenEmployee);const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,'Employees');XLSX.writeFile(wb,'employees.xlsx')}
export function exportTimesheetToXLSX(emp,weekStartISO,records){const rows=(records||[]).map(r=>({project:r.project,mon:r.mon||0,tue:r.tue||0,wed:r.wed||0,thu:r.thu||0,fri:r.fri||0,sat:r.sat||0,sun:r.sun||0}));const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet(rows);XLSX.utils.book_append_sheet(wb,ws,`Timesheet_${emp.name}`);XLSX.writeFile(wb,`timesheet_${emp.id}_${weekStartISO}.xlsx`)}
export function exportPayslipToXLSX(p){const wb=XLSX.utils.book_new();const ws=XLSX.utils.json_to_sheet([p]);XLSX.utils.book_append_sheet(wb,ws,'Payslip');XLSX.writeFile(wb,`payslip_${p.employeeId}_${p.periodStart}_to_${p.periodEnd}.xlsx`)}
export function exportPayslipToPDF(p,opts={}){const {company={}}=opts;const doc=new jsPDF();doc.setDrawColor(15,42,107);doc.setLineWidth(0.8);doc.line(14,24,196,24);doc.setFontSize(18);doc.text(company.name||'Company',14,20);doc.setFontSize(11);const addr=company.address||'';if(addr)doc.text(addr,14,28);doc.setFontSize(12);doc.text(`To: ${p.employeeName} (${p.employeeId})`,14,40);doc.text(`Period: ${p.periodStart} → ${p.periodEnd}`,14,47);let y=58;const colX=[14,120,150,180];doc.setFontSize(11);doc.text('Описание',colX[0],y);doc.text('Кол-во',colX[1],y);doc.text('Ставка',colX[2],y);doc.text('Сума',colX[3],y);y+=4;doc.setLineWidth(0.4);doc.line(14,y,196,y);y+=8;const addRow=(d,q,r,a)=>{doc.text(String(d),colX[0],y);if(q!=null)doc.text(String(q),colX[1],y);if(r!=null)doc.text(String(r),colX[2],y);doc.text(String(a),colX[3],y);y+=8};addRow('Отработени часове',p.hours,p.rate.toFixed(2),p.gross.toFixed(2));addRow('Данъци',null,null,'-'+p.taxes.toFixed(2));addRow('Осигуровки',null,null,'-'+p.insurance.toFixed(2));if(p.extraExpenses)addRow('Разходи (възстановими)',null,null,'+'+Number(p.extraExpenses).toFixed(2));if(p.extraDeductions)addRow('Удръжки',null,null,'-'+Number(p.extraDeductions).toFixed(2));y+=2;doc.line(14,y,196,y);y+=8;doc.setFontSize(12);doc.text('Дължимо',colX[2],y);const net=(p.finalNet??p.net);doc.text(String(net.toFixed?net.toFixed(2):net),colX[3],y);doc.setDrawColor(15,42,107);doc.setLineWidth(0.8);doc.line(14,280,196,280);doc.save(`payslip_${p.employeeId}_${p.periodStart}_to_${p.periodEnd}.pdf`)}
